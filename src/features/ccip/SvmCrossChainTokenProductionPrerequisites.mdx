import { Aside } from "@components"

## Prerequisites

### System Requirements

Install these tools before starting:

**Package Managers:**

- **Node.js v20+**: Required for all repositories
- **pnpm**: Required for base58 Generator (`npm install -g pnpm`)
- **yarn**: Required for Solana Starter Kit (`npm install -g yarn`)

**Solana Development:**

- **Solana CLI**: [Installation guide](https://docs.solana.com/cli/install-solana-cli-tools)

**Wallets:**

- **Solana wallet**: [Phantom](https://phantom.app/) or [Backpack](https://backpack.app/) for Devnet operations
- **Ethereum wallet**: [MetaMask](https://metamask.io/) for Sepolia testnet operations

### Repository Setup

Clone and install dependencies for all three repositories:

**Terminal 1: base58 Generator**

```bash
git clone https://github.com/smartcontractkit/ccip-solana-bs58-generator.git
cd ccip-solana-bs58-generator
pnpm install
```

**Terminal 2: EVM Hardhat**

```bash
git clone https://github.com/smartcontractkit/smart-contract-examples.git
cd smart-contract-examples/ccip/cct/hardhat
npm install
npm run compile
```

**Terminal 3: Solana Starter Kit**

```bash
git clone https://github.com/smartcontractkit/solana-starter-kit.git
cd solana-starter-kit
yarn install
```

**Create and configure the .env file:**

```bash
# Create .env file in the project root
cat > .env << 'EOF'
EVM_PRIVATE_KEY=your_private_key_here
EVM_RPC_URL=your_rpc_url_here
EOF
```

Replace the placeholder values with:

- `EVM_PRIVATE_KEY`: Your Ethereum wallet private key (for Sepolia testnet operations)
- `EVM_RPC_URL`: Your Ethereum RPC URL (from [Alchemy](https://www.alchemy.com/), [Infura](https://www.infura.io/), or another provider)

### Environment Configuration

**Solana Configuration:**

```bash
# Set Solana CLI to devnet
solana config set --url https://api.devnet.solana.com

# Create keypair (ONLY IF NEEDED)
solana-keygen new --outfile ~/.config/solana/id.json

# Check Config
solana config get

# Fund wallet
solana airdrop 3
```

**Ethereum Sepolia Configuration:**

```bash
# In Terminal 2 (Hardhat directory)
npx env-enc set-pw
npx env-enc set
```

Required environment variables:

- `ETHEREUM_SEPOLIA_RPC_URL`: RPC endpoint ([Alchemy](https://www.alchemy.com/) or [Infura](https://www.infura.io/))
- `PRIVATE_KEY`: Testnet wallet private key
- `ETHERSCAN_API_KEY`: API key from [Etherscan](https://etherscan.io/apis)

**Testnet Tokens:**

- **Solana Devnet**: Use `solana airdrop 3` for SOL
- **Ethereum Sepolia**: Use [Chainlink faucets](https://faucets.chain.link/) for LINK and ETH

### Squads Multisig Setup

<Aside type="caution" title="Required: Create Squads Multisig">
  **Before starting this tutorial**, you must create a Squads multisig on Solana Devnet. This will serve as your
  governance mechanism for all CCIP administrative operations.
</Aside>

**Step 1: Prepare Signers**

Create multiple wallet addresses for your multisig signers:

```bash
# Create additional signers using Solana CLI
solana-keygen new --outfile ~/.config/solana/signer2.json
solana-keygen new --outfile ~/.config/solana/signer3.json

# Get signer addresses
solana address --keypair ~/.config/solana/id.json
solana address --keypair ~/.config/solana/signer2.json
solana address --keypair ~/.config/solana/signer3.json

# Fund signers (minimum 0.1 SOL each for transaction fees)
solana transfer <SIGNER2_ADDRESS> 0.1 --allow-unfunded-recipient
solana transfer <SIGNER3_ADDRESS> 0.1 --allow-unfunded-recipient
```

Alternatively, create signers in Phantom wallet and fund them:

```bash
# Transfer SOL to Phantom-created addresses
solana transfer <PHANTOM_SIGNER_ADDRESS> 0.5 --allow-unfunded-recipient
```

**Step 2: Create Your Squad**

1. Visit [devnet.squads.so](https://devnet.squads.so)
1. Connect your Solana wallet (e.g., Phantom/Backpack)
1. Click "Create New Squad"
1. Configure your multisig:
   - **Squad Name**: Choose a descriptive name (e.g., "CCIP Token Governance")
   - **Members**: Add wallet addresses of all signers
   - **Threshold**: Set approval threshold (recommended: 2/3 or 3/5)

<Aside type="note" title="Threshold Best Practices">

- **Avoid 1/n thresholds** (single point of failure)
- **Avoid maximum thresholds** (e.g., 3/3 prevents recovery if one key is lost)

</Aside>

**Step 3: Record Critical Addresses**

After Squad creation, navigate to Settings tab and record these addresses.

**In Terminal 1 (base58 Generator), export the vault address:**

```bash
# CRITICAL: Use the VAULT address, NOT the multisig address
export SOL_SQUAD_VAULT_MULTISIG="YOUR_VAULT_ADDRESS_HERE"
```

Verify the export:

```bash
echo "Squads Vault Address: $SOL_SQUAD_VAULT_MULTISIG"
```

<Aside type="caution" title="Vault vs Multisig Address">
  **IMPORTANT**: Only use the **Vault address** for setting authorities and receiving funds. The **Multisig address** is
  used only for CLI detection - sending assets to it causes **irreversible loss**.
</Aside>

**Step 4: Test Your Squad**

Perform a small test transaction to verify setup:

1. Send a small amount of SOL to your Squad vault
1. Create a test transaction in Squads UI (e.g., SOL transfer to your wallet)
1. Confirm all signers can approve transactions
1. Execute the transaction

For detailed setup guidance, see the [Squads Documentation](https://docs.squads.so/).

### Token Creation Option

<Aside type="note" title="Existing Token Requirements">
  **Important**: You can only skip token creation if you have an existing SPL token where the **mint authority is already controlled by your Squad vault**.

**Two scenarios:**

1. **Mint authority = Squad vault**: Skip to Step 3 (pool initialization) and export your existing mint address
1. **Mint authority ≠ Squad vault**: You must first transfer mint authority to your Squad vault, OR create a fresh token in Step 2

**For fresh start**: Proceed with Step 2 to create a new token with Squad vault as mint authority from the beginning.

</Aside>

## Tutorial Approach

This tutorial implements production-grade cross-chain tokens using a three-terminal workflow across specialized repositories:

| Terminal       | Repository                                                                                                                  | Purpose                          | Commands      |
| -------------- | --------------------------------------------------------------------------------------------------------------------------- | -------------------------------- | ------------- |
| **Terminal 1** | [CCIP Solana base58 Generator](https://github.com/smartcontractkit/ccip-solana-bs58-generator)                              | Generate governance transactions | `pnpm bs58`   |
| **Terminal 2** | [Smart Contract Examples (Hardhat)](https://github.com/smartcontractkit/smart-contract-examples/tree/main/ccip/cct/hardhat) | Deploy EVM components            | `npx hardhat` |
| **Terminal 3** | [Solana Starter Kit](https://github.com/smartcontractkit/solana-starter-kit)                                                | Test cross-chain transfers       | `yarn`        |

**Note**: Each repository contains comprehensive READMEs with detailed technical explanations and troubleshooting guides.

### Key Implementation Notes

- **Terminal 1** generates base58-encoded transactions for Squads multisig governance
- **Terminal 2** uses EOA for tutorial simplicity; production deployments should use multisig wallets (e.g., Safe)
- **Terminal 3** validates end-to-end cross-chain functionality

### base58 Transaction Execution Workflow

**Transaction Generation and Validation:**

1. **CLI Simulation**: Each base58 transaction is automatically simulated during generation
1. **Error Handling**: If simulation fails, error logs appear in terminal - do not upload failed transactions to Squads
1. **Success Indicator**: Successful simulation shows transaction preview and base58 output

**Squads Multisig Execution Process:**

1. **Propose**: A signer imports the base58 transaction into Squads UI → "Add instruction" → "Import base58 encoded tx" → **Initiate Transaction**
1. **Approve**: Required threshold (M) of signers review and approve the transaction
1. **Simulate** (Recommended): Before execution, signers can simulate through Squads interface to preview onchain effects
1. **Execute**: After threshold approval, any signer can execute the transaction

<Aside type="note" title="Security Best Practice">
  Always simulate before execution using Squads' built-in simulation feature. This shows exactly what will happen
  onchain and is critical for validating complex governance operations before commitment.
</Aside>

### Environment Variables

Variables use prefixes to prevent confusion across repositories:

| Prefix   | Usage              | Examples                                   |
| -------- | ------------------ | ------------------------------------------ |
| `ETH_*`  | Ethereum addresses | `ETH_TOKEN_ADDRESS`, `ETH_POOL_ADDRESS`    |
| `SOL_*`  | Solana addresses   | `SOL_TOKEN_MINT`, `SOL_POOL_ADDRESS`       |
| `CCIP_*` | Protocol constants | `CCIP_POOL_PROGRAM`, `CCIP_ROUTER_PROGRAM` |
