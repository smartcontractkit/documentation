---
import { Sections } from "~/content.config"
import { SIDEBAR } from "../../config"
import type { SectionEntry, SectionContent } from "../../config"
import RecursiveSidebar from "./RecursiveSidebar.astro"
import { LanguageSwitcherDropdown } from "~/components/LanguageSwitcherDropdown"
import { ChainTypeSelector } from "~/components/ChainSelector"
import { isChainAwareSection } from "~/config/chainTypes"
import styles from "./leftSidebar.module.css"
import DocsHeaderTitle from "../DocsHeaderTitle/DocsHeaderTitle.astro"
import * as CONFIG from "../../config"

type SectionEntryWithParent = SectionEntry & { parentSection?: string }

export type Props = {
  currentPage: string
  section?: Sections
}

const { currentPage, section } = Astro.props

// Check if this section supports chain type filtering
const showChainSelector = isChainAwareSection(section)

// Return whichever sections we need
function getSidebarSections(section?: Sections): SectionEntryWithParent[] {
  if (!section) {
    return []
  } else if (section === "global") {
    // Flatten all sidebar entries into one array
    return Object.entries(SIDEBAR).flatMap(([parentSection, entries]) => {
      return entries?.map((entry) => ({ ...entry, parentSection })) ?? []
    })
  }
  return SIDEBAR[section] ?? []
}

/**
 * Determines if a section should be expanded based on its contents
 */
function shouldExpandTopSection(contents: SectionEntry["contents"], currentPage: string): boolean {
  const normalizedCurrentPage = removeSlashes(currentPage.slice(1))

  // Helper function to check if an item or its children match the current page exactly
  function checkItem(item: SectionContent): boolean {
    // Check if current page matches this item exactly
    if (item.url) {
      const normalizedItemUrl = removeSlashes(item.url)

      // Direct match
      if (normalizedCurrentPage === normalizedItemUrl) {
        return true
      }

      // Check highlightAsCurrent array
      if (item.highlightAsCurrent?.some((url) => normalizedCurrentPage === removeSlashes(url))) {
        return true
      }
    }

    // Check children recursively for exact matches
    if (item.children) {
      return item.children.some(checkItem)
    }

    return false
  }

  // Check all items in the section for exact matches
  return contents.some(checkItem)
}

function removeSlashes(url: string): string {
  let sanitizedUrl = url
  sanitizedUrl = sanitizedUrl.split("?parent")[0]
  if (sanitizedUrl.charAt(0) == "/") sanitizedUrl = sanitizedUrl.substr(1)
  if (sanitizedUrl.charAt(sanitizedUrl.length - 1) == "/")
    sanitizedUrl = sanitizedUrl.substr(0, sanitizedUrl.length - 1)
  return sanitizedUrl
}

const sidebarSections = getSidebarSections(section)
---

<nav aria-labelledby="grid-left" class={styles.nav} data-sticky>
  <DocsHeaderTitle pathname={currentPage} />
  {
    section === "cre" && (
      <div class={styles.languageSwitcherTablet}>
        <LanguageSwitcherDropdown client:only="react" />
      </div>
    )
  }
  {showChainSelector && <ChainTypeSelector client:only="react" />}
  <ul class={styles.navGroups}>
    {
      sidebarSections.map((group) => (
        <li
          style={section === "global" ? { display: "none" } : {}}
          class={group.parentSection ? `parent-${group.parentSection}` : ""}
        >
          <details open={shouldExpandTopSection(group.contents, currentPage)}>
            <summary class={styles.navGroupTitle}>{group.section}</summary>
            <ul class={styles.navGroupEntries}>
              <RecursiveSidebar items={group.contents} currentPage={currentPage} />
            </ul>
          </details>
        </li>
      ))
    }
    <div class={styles.quickLinks}>
      <li class={styles.headerLink}>
        <a href="/builders-quick-links" target="_blank" id="quick-links-sidebar-link">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M2.5 9.20055L7.18129 2H12.2965L9.62194 5.59959H13.5L5.97787 14H4.50671L7.18135 9.20055H2.5Z"
              fill="#0D5DFF"></path>
          </svg>
          <p>Quick links</p>
        </a>
      </li>
      <li class={styles.headerLink}>
        <a
          class={styles.link}
          href="https://github.com/smartcontractkit/documentation"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img height={16} width={16} src="/assets/icons/github-blue.svg" alt="GitHub repository" />
          <span>Github</span>
        </a>
      </li>
      {
        CONFIG.COMMUNITY_INVITE_URL && (
          <li class={styles.headerLink}>
            <a href={CONFIG.COMMUNITY_INVITE_URL} target="_blank" rel="noopener noreferrer">
              <img src="/images/discord.svg" loading="lazy" width="16" height="16" alt="Discord" />
              <span>Join our community</span>
            </a>
          </li>
        )
      }
    </div>
  </ul>
</nav>

<style is:global>
  .nav-link svg {
    min-height: 12px;
    min-width: 12px;
    opacity: 0;
    display: none;
  }

  .nav-link[aria-current="page"] svg {
    opacity: 0;
  }
</style>

<script>
  import { initializeChainType } from "~/stores/chainType"

  /**
   * Initialize chain type selection from URL on page load
   * This detects the chain from the URL path (e.g., /ccip/tutorials/svm/... â†’ solana)
   */
  initializeChainType()

  /**
   * Re-initialize on client-side navigation (Astro view transitions)
   */
  document.addEventListener("astro:after-swap", () => {
    initializeChainType()
  })

  /**
   * Handles section visibility based on URL parameters
   * - Shows/hides sections based on the 'parent' query parameter
   * - Runs on initial load and after navigation
   */
  const attachContentScripts = () => {
    const parentSection = new URLSearchParams(window.location.search).get("parent") || "global"
    if (parentSection) {
      for (let elem of document.querySelectorAll(`.parent-${parentSection}`)) {
        ;(elem as HTMLElement).style.display = "block"
      }
    }
  }

  // Runs on initial navigation
  attachContentScripts()
  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", attachContentScripts)
</script>

<script>
  import { selectedChainType } from "~/stores/chainType"

  /**
   * Filters sidebar items based on selected chain type
   * Triggers the unified filter in RecursiveSidebar that respects BOTH chain type AND language
   */
  function filterSidebarByChainType() {
    // trigger a languageChanged event to run the unified filter
    window.dispatchEvent(new CustomEvent("languageChanged"))
  }

  // Run on initial load
  filterSidebarByChainType()

  // Run after view transitions
  document.addEventListener("astro:after-swap", filterSidebarByChainType)

  // Subscribe to chain type changes
  selectedChainType.subscribe(() => {
    filterSidebarByChainType()
  })
</script>
