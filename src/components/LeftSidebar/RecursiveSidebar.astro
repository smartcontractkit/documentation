---
import type { SectionContent } from "../../config"
import styles from "./recursiveSidebar.module.css"
import { getCollection } from "astro:content"

/** Props for this recursive component */
interface Props {
  items: SectionContent[]
  currentPage: string
}

const { items, currentPage } = Astro.props

const allPages = await getCollection("cre")
const pageSdkLangMap = new Map<string, string>()
allPages.forEach((page) => {
  if (page.data.sdkLang) {
    pageSdkLangMap.set(`cre/${page.id.replace(/\.mdx?$/, "")}`, page.data.sdkLang)
  }
})

/** Removes leading/trailing slashes, plus anything after "?" */
function removeSlashes(url: string): string {
  let sanitizedUrl = url
  sanitizedUrl = sanitizedUrl.split("?parent")[0]
  if (sanitizedUrl.charAt(0) == "/") sanitizedUrl = sanitizedUrl.substr(1)
  if (sanitizedUrl.charAt(sanitizedUrl.length - 1) == "/")
    sanitizedUrl = sanitizedUrl.substr(0, sanitizedUrl.length - 1)
  return sanitizedUrl
}

/** Checks if the URL is external (starts with http:// or https://) */
function isExternalUrl(url: string): boolean {
  return url.startsWith("http://") || url.startsWith("https://")
}

/** Builds the correct href based on whether the URL is internal or external */
function buildHref(url: string): string {
  if (isExternalUrl(url)) {
    return url // Return external URLs as-is
  }
  return `${Astro.site?.pathname}${url}` // Prepend base path for internal URLs
}

/**
 * Determines if a page matches the current page or should be highlighted.
 * Handles:
 * 1. Direct URL matches
 * 2. URLs specified in highlightAsCurrent array
 */
function isCurrentPageMatch(sectionUrl: string, currentPage: string, highlightAsCurrent: string[] = []): boolean {
  if (!sectionUrl) return false

  // External URLs should never match the current page
  if (isExternalUrl(sectionUrl)) return false

  const normalizedSectionUrl = removeSlashes(sectionUrl)
  const normalizedCurrentPage = removeSlashes(currentPage.slice(1))

  // Direct match only
  if (normalizedCurrentPage === normalizedSectionUrl) {
    return true
  }

  // Check highlightAsCurrent array
  if (highlightAsCurrent?.some((url) => removeSlashes(url) === normalizedCurrentPage)) {
    return true
  }

  return false
}

/**
 * Determines if a section should be expanded based on whether the current page
 * is this item or any of its descendants
 */
function shouldExpandSection(item: SectionContent, currentPage: string): boolean {
  const normalizedCurrentPage = removeSlashes(currentPage.slice(1))

  // For external URLs, we don't need to expand the section
  if (item.url && isExternalUrl(item.url)) {
    return false
  }

  const normalizedItemUrl = item.url ? removeSlashes(item.url) : ""

  // If this item has a URL, check if the current page is this item or a descendant
  if (normalizedItemUrl) {
    // Direct match
    if (normalizedCurrentPage === normalizedItemUrl) {
      return true
    }

    // Check highlightAsCurrent array for this item
    if (item.highlightAsCurrent?.some((url) => removeSlashes(url) === normalizedCurrentPage)) {
      return true
    }

    // Check if current page is a descendant
    if (normalizedCurrentPage.startsWith(normalizedItemUrl + "/")) {
      return true
    }
  }

  // If this item has children, check if any child should be expanded
  if (item.children) {
    return item.children.some((child) => shouldExpandSection(child, currentPage))
  }

  return false
}
---

<ul class={styles.list}>
  {
    items.map((item) => {
      const sdkLang = item.url ? pageSdkLangMap.get(item.url) : undefined
      const chainTypes = item.chainTypes
      const chainAttr = chainTypes ? chainTypes.join(",") : "universal"
      return (
        <li data-sdk-lang={sdkLang || "both"} data-chain-types={chainAttr}>
          {item.children ? (
            <details open={shouldExpandSection(item, currentPage)}>
              <summary
                class={`${styles.navLink} ${isCurrentPageMatch(item.url || "", currentPage, item.highlightAsCurrent) ? styles.active : ""}`}
              >
                {item.url ? (
                  <a
                    class={isCurrentPageMatch(item.url, currentPage, item.highlightAsCurrent) ? styles.active : ""}
                    href={buildHref(item.url)}
                    aria-current={
                      isCurrentPageMatch(item.url, currentPage, item.highlightAsCurrent) ? "page" : undefined
                    }
                    target={isExternalUrl(item.url) ? "_blank" : undefined}
                    rel={isExternalUrl(item.url) ? "noopener noreferrer" : undefined}
                  >
                    {item.title}
                  </a>
                ) : (
                  item.title
                )}
              </summary>
              <ul class={`${styles.navGroupEntries} ${styles.nested}`}>
                <Astro.self items={item.children} currentPage={currentPage} />
              </ul>
            </details>
          ) : (
            item.url && (
              <a
                class={`${styles.navLink} ${isCurrentPageMatch(item.url, currentPage, item.highlightAsCurrent) ? styles.active : ""}`}
                href={buildHref(item.url)}
                aria-current={isCurrentPageMatch(item.url, currentPage, item.highlightAsCurrent) ? "page" : undefined}
                target={isExternalUrl(item.url) ? "_blank" : undefined}
                rel={isExternalUrl(item.url) ? "noopener noreferrer" : undefined}
              >
                {item.title}
              </a>
            )
          )}
        </li>
      )
    })
  }
</ul>

<script>
  /**
   * Filters sidebar items based on selected SDK language
   * - Hides items with data-sdk-lang that don't match current selection
   * - Runs on initial load and when language changes
   */
  function filterSidebarByLanguage() {
    // Get current language from localStorage
    let currentLang = "go" // default
    try {
      const stored = localStorage.getItem("docs-language-preference")
      if (stored) {
        currentLang = stored === "ts" || stored === '"ts"' ? "ts" : "go"
      }
    } catch {
      // Fallback to default
    }

    // Find all sidebar items with data-sdk-lang attribute
    const sidebarItems = document.querySelectorAll<HTMLElement>("[data-sdk-lang]")

    sidebarItems.forEach((item) => {
      const sdkLang = item.getAttribute("data-sdk-lang")

      if (sdkLang === "both") {
        // Always show items that are language-agnostic
        item.style.display = ""
      } else if (sdkLang !== currentLang) {
        // Hide items that don't match current language
        item.style.display = "none"
      } else {
        // Show items that match current language
        item.style.display = ""
      }
    })
  }

  // Run on initial load
  filterSidebarByLanguage()

  // Run after view transitions
  document.addEventListener("astro:after-swap", filterSidebarByLanguage)

  // Listen for language changes
  window.addEventListener("languageChanged", filterSidebarByLanguage)
</script>
