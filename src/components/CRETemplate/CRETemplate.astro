<article id="article">
  <slot />
</article>

<style is:inline>
  article {
    margin-top: 0;
  }

  article * {
    margin-top: 0;
    margin-bottom: 0;
    max-width: 100%;
  }

  article section:target {
    scroll-margin-top: var(--theme-navbar-height);
  }

  article section > section:target {
    scroll-margin-top: calc(var(--theme-navbar-height) + var(--space-12x));
  }

  article > :not(section, astro-slot, astro-island, ul, ol),
  article :where(section, astro-slot, astro-island) > :not(section, astro-slot, astro-island, ul, ol) {
    margin-top: var(--space-5x);
  }

  :where(article, article section) > :not(astro-accordion, h2, h3, h4):has(+ astro-accordion) {
    margin-bottom: var(--space-5x);
  }

  /* Consistent spacing after headings */
  :where(article, article section) > h2 + :not(section, astro-slot, astro-island) {
    margin-top: var(--space-5x) !important;
  }

  :where(article, article section) > :is(h3, h4) + :not(section, astro-slot, astro-island) {
    margin-top: var(--space-5x) !important;
  }

  /* Section padding */
  :where(article, astro-island, astro-slot) > section {
    padding-top: var(--space-5x);
  }

  /* H2 styling - card style headers */
  article > h2 {
    margin-top: var(--space-8x) !important;
    padding-top: var(--space-6x);
    border-top: 1px solid #e5e7eb;
  }

  article > h2:first-child {
    margin-top: 0 !important;
    padding-top: 0;
    border-top: none;
  }

  article :is(h2, h3, h4, h5, h6) {
    margin-top: 0 !important;
  }

  article :is(h2, h3, h4, h5, h6, p, li) {
    word-break: break-word;
  }

  :where(article, article section) > :is(h2, h3, h4, h5, h6) > a {
    display: inline-block;
    color: inherit;
    width: 100%;
    text-decoration: none;
  }

  :where(article, article section) > :is(h2, h3, h4, h5, h6) {
    color: #0b101c;
    margin-top: 0;
  }

  :where(article, article section) > h2 {
    font-size: 24px;
    font-weight: 700;
    line-height: 1.3;
  }

  :where(article, article section) > h2 > a {
    overflow: hidden;
    text-overflow: ellipsis;
    line-clamp: 3;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  :where(article, article section) > h3 {
    padding-top: var(--space-6x);
    font-size: 20px;
    font-weight: 600;
  }

  :where(article, article section) > h4 {
    padding-top: var(--space-6x);
    font-weight: 600;
  }

  :where(article, article section) > :is(h4, h5, h6) {
    font-size: 16px;
  }

  /* List styling */
  article ul {
    padding-left: calc(var(--space-2x) + 2px);
    list-style: none;
  }

  article ol {
    padding-left: calc(var(--space-6x) + 2px);
  }

  article :is(ul, ol) {
    margin-top: var(--space-3x);
  }

  article :is(ul, ol) > li,
  article :is(ul, ol) > li > :is(ul, ol) {
    margin-top: var(--space-1x);
  }

  article li {
    line-height: 1.6;
    color: #374151;
  }

  article li > * {
    margin-top: var(--space-2x);
  }

  article ul > li {
    position: relative;
    left: 0.5rem;
    padding-right: 1rem;
  }

  article ul > li::before {
    position: absolute;
    content: "â—";
    font-size: 0.5rem;
    top: 8px;
    left: -1rem;
    color: #0847f7;
  }

  /* Paragraph styling */
  article p {
    color: #374151;
    line-height: 1.7;
  }

  /* Link styling - exclude heading links */
  article a:not(.button):not(h1 a):not(h2 a):not(h3 a):not(h4 a):not(h5 a):not(h6 a) {
    color: #0847f7;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
  }

  article a:not(.button):not(h1 a):not(h2 a):not(h3 a):not(h4 a):not(h5 a):not(h6 a):hover {
    border-bottom-color: #0847f7;
  }

  /* Heading links should not have underline */
  article :is(h1, h2, h3, h4, h5, h6) a {
    border-bottom: none !important;
  }

  /* Code styling */
  article code:not(pre code) {
    background: #f8faff;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #0b101c;
  }

  article pre {
    background: #1e293b;
    border-radius: 8px;
    padding: var(--space-4x);
    overflow-x: auto;
    position: relative;
  }

  article pre code {
    background: none;
    padding: 0;
    color: #e2e8f0;
    font-size: 14px;
    line-height: 1.6;
  }

  /* Copy button for code blocks */
  article :global(.cre-copy-btn) {
    position: absolute !important;
    top: 10px !important;
    right: 10px !important;
    left: auto !important;
    bottom: auto !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    padding: 0;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s ease;
    z-index: 10;
  }

  article pre:hover :global(.cre-copy-btn) {
    opacity: 1;
  }

  article :global(.cre-copy-btn:hover) {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    opacity: 1;
  }

  article :global(.cre-copy-btn.copied) {
    background: rgba(74, 222, 128, 0.3);
    border-color: rgba(74, 222, 128, 0.5);
    color: #4ade80;
    opacity: 1;
  }

  /* Table styling */
  article table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--space-4x);
    font-size: 14px;
  }

  article th,
  article td {
    padding: var(--space-3x) var(--space-4x);
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  article th {
    background: #f8faff;
    font-weight: 600;
    color: #0b101c;
  }

  article td {
    color: #374151;
  }

  @media (min-width: 48em) {
    article > :not(section, astro-slot, astro-island, ul, ol),
    article :where(section, astro-slot, astro-island) > :not(section, astro-slot, astro-island, ul, ol) {
      margin-top: var(--space-6x);
    }

    :where(article, article section) > :not(astro-accordion, h2, h3, h4):has(+ astro-accordion) {
      margin-bottom: var(--space-6x);
    }

    :where(article, article section) > :is(h3, h4) + :not(section, astro-slot, astro-island) {
      margin-top: var(--space-5x) !important;
    }

    :where(article, astro-island, astro-slot) > section {
      padding-top: var(--space-6x);
    }

    article > h2 {
      margin-top: var(--space-10x) !important;
    }

    :where(article, article section) > h2 {
      font-size: 28px;
    }

    :where(article, article section) > h3 {
      font-size: 22px;
    }

    :where(article, article section) > :is(h4, h5, h6) {
      font-size: 18px;
    }
  }

  /* ==========================================
     Modern Accordion Overrides for CRE Templates
     ========================================== */

  /* Remove default border lines */
  article :global(astro-accordion details) {
    border: none !important;
    background: transparent;
    border-radius: 8px;
    margin-bottom: var(--space-2x);
    transition: background 0.2s ease;
  }

  /* Subtle background on hover */
  article :global(astro-accordion details:hover) {
    background: #f8faff;
  }

  /* Background when expanded */
  article :global(astro-accordion details[expanded]) {
    background: #f8faff;
  }

  /* Summary (clickable header) styling */
  article :global(astro-accordion summary) {
    display: flex;
    align-items: center;
    gap: 24px;
    padding: var(--space-4x) var(--space-4x) var(--space-4x) var(--space-5x);
    font-size: 16px;
    font-weight: 600;
    color: #0b101c;
    cursor: pointer;
    border-radius: 8px;
    transition: color 0.2s ease;
  }

  article :global(astro-accordion summary:hover) {
    color: #0847f7;
  }

  /* Hide default marker */
  article :global(astro-accordion summary::-webkit-details-marker) {
    display: none;
  }

  article :global(astro-accordion summary::marker) {
    display: none;
    content: "";
  }

  /* Number styling - more subtle */
  article :global(astro-accordion summary span.before) {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    margin-right: 12px;
    background: #e5e7eb;
    color: #5a6175;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    flex-shrink: 0;
    transition:
      background 0.2s ease,
      color 0.2s ease;
  }

  article :global(astro-accordion details[expanded] summary span.before) {
    background: #0847f7 !important;
    color: white !important;
  }

  /* Custom chevron icon */
  article :global(astro-accordion summary::after) {
    content: "";
    width: 20px;
    height: 20px;
    margin-left: auto;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%235a6175' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 20px;
    transition: transform 0.25s ease;
    -webkit-mask: none;
    mask: none;
    background-color: transparent;
  }

  article :global(astro-accordion details[expanded] > summary::after) {
    transform: rotate(180deg);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230847F7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  }

  /* Content area styling */
  article :global(astro-accordion .accordionContent) {
    padding: 0 var(--space-4x) var(--space-4x) var(--space-4x);
    margin-left: calc(24px + var(--space-3x));
  }

  /* Section headers above accordions - cleaner look */
  article h2:has(+ astro-accordion),
  article h3:has(+ astro-accordion) {
    border-bottom: none;
    padding-bottom: var(--space-2x);
  }

  @media (min-width: 48em) {
    article :global(astro-accordion summary) {
      font-size: 17px;
      gap: 24px;
      padding: var(--space-4x) var(--space-5x) var(--space-4x) var(--space-6x);
    }

    article :global(astro-accordion .accordionContent) {
      padding: 0 var(--space-5x) var(--space-5x) var(--space-5x);
      margin-left: calc(28px + 12px + var(--space-3x));
    }
  }
</style>

<script>
  import { prepareSections } from "~/scripts/prepArticleContent.ts"

  // Runs on initial navigation
  prepareSections()
  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", () => prepareSections())

  // Add copy buttons to all code blocks in CRE templates
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll("article pre:not(.code-sample__pre)")

    codeBlocks.forEach((pre) => {
      // Skip if already has a copy button
      if (pre.querySelector(".cre-copy-btn")) return

      // Create copy button with inline styles to ensure positioning
      const copyBtn = document.createElement("button")
      copyBtn.className = "cre-copy-btn"
      copyBtn.setAttribute("aria-label", "Copy code")

      // Apply inline styles directly
      copyBtn.style.cssText = `
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        left: auto !important;
        bottom: auto !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        padding: 0;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
      `

      copyBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `

      // Hover effects
      copyBtn.addEventListener("mouseenter", () => {
        copyBtn.style.background = "rgba(255, 255, 255, 0.25)"
        copyBtn.style.color = "white"
      })
      copyBtn.addEventListener("mouseleave", () => {
        if (!copyBtn.classList.contains("copied")) {
          copyBtn.style.background = "rgba(255, 255, 255, 0.15)"
          copyBtn.style.color = "rgba(255, 255, 255, 0.85)"
        }
      })

      // Position the pre element relative for absolute positioning of button
      const preEl = pre as HTMLElement
      preEl.style.position = "relative"

      // Add click handler
      copyBtn.addEventListener("click", async () => {
        const code = pre.querySelector("code")
        const text = code?.textContent || ""

        try {
          await navigator.clipboard.writeText(text)
          copyBtn.classList.add("copied")
          copyBtn.style.background = "rgba(74, 222, 128, 0.3)"
          copyBtn.style.borderColor = "rgba(74, 222, 128, 0.5)"
          copyBtn.style.color = "#4ade80"
          copyBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
          `
          setTimeout(() => {
            copyBtn.classList.remove("copied")
            copyBtn.style.background = "rgba(255, 255, 255, 0.15)"
            copyBtn.style.borderColor = "rgba(255, 255, 255, 0.3)"
            copyBtn.style.color = "rgba(255, 255, 255, 0.85)"
            copyBtn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            `
          }, 2000)
        } catch (err) {
          console.error("Failed to copy:", err)
        }
      })

      pre.appendChild(copyBtn)
    })
  }

  // Run on load and view transitions
  addCopyButtons()
  document.addEventListener("astro:after-swap", () => addCopyButtons())
</script>
